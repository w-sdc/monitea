import { Button, Slider, VerticalBox, ScrollView, SpinBox, Spinner, TabWidget, ComboBox } from "std-widgets.slint";
import { LevelMeter } from "../slintcomponents/lib.slint";

// Levelmeter info
export struct TChannelMeter {
  levels: [float],
  peak_flag: [bool],
}

// Channel info
export struct TChannel {
  gain: int,
  mute: bool,
  dev_id: int,
  meter: TChannelMeter,
}

// Meeting member info
export struct TMemberInfo {
  site: int,
  name: string,
  avatar: image,
  description: string,
}

// Meeting member instance
export struct TMember  {
  info: TMemberInfo,
  channel: TChannel,
}

// Connect state
export enum TSelfConnectState  {
  disconnected,
  connecting,
  connected,
}

export enum TRemoteMasterState {
  idle,
  connecting,
  moinitoring,
}

// Work mode
export enum TSelfMode {
  master,
  voicer,
}

// Self plane info
export struct TSelfPlane {
  info: TMemberInfo,
  mode: TSelfMode,
  master_info: TMemberInfo,
  channel_master: TChannel,
  channel_voice: TChannel,
  channel_devout: TChannel,
  connect_state: TSelfConnectState,
}

// A avatar button
component AvatarButton inherits Rectangle {
  in property <image> avatar_image : @image-url("./resources/icon-default-user.png");
  callback clicked();
  width: 44px;
  height: 44px;
  border-width: 2px;
  border-color: #888;
  border-radius: 22px;
  clip: true;
  Image {
      source: avatar_image;
      width: parent.width;
      height: parent.height;
  }
  TouchArea {
    clicked => {
        root.clicked();
    }
  }
}

// A customizable color button
component ColorButton {
  in property <string> text : "Button";
  in property <length> border-radius : 4px;
  in property <length> border-width : 2px;
  in property <color> border-color : #444;
  in property <color> text-color : #aaa;
  in property <color> background-color : #444;
  in property <color> hover-text-color : #fff;
  in property <color> hover-background-color : #666;
  in property <color> hover-border-color : #333;

  callback clicked();

  width: 100px;
  height: 30px;
  TouchArea {
    mouse-cursor: pointer;
    clicked => {
      root.clicked();
    }
    
    Rectangle {
      private property <bool> has-hover : parent.has-hover;
      border-color: has-hover ? root.hover-border-color : root.border-color;
      border-width: 2px;
      border-radius: 4px;
      background: has-hover ? root.hover-background-color : root.background-color;
      Text {
        x: parent.border-width + 5px;
        y: parent.border-width;
        text: root.text;
        horizontal-alignment: center;
        vertical-alignment: center;
        width: parent.width - parent.border-width * 2 - 10px;
        height: parent.height - parent.border-width * 2;
        color: parent.has-hover ? root.hover-text-color : root.text-color;
      } 
    }
  }
}

// A mini checkbox component
component MiniCheckbox inherits Rectangle {
  in property <string> text : "Check";
  in-out property <bool> checked : false;
  in property <bool> rightalign : false;
  in property <length> font-size : 11px;
  in property <string> font-family : "Sans Serif";
  in property <color> front-color : #ccc;
  in property <color> checked-color : #B66;
  callback toggled(bool);

  HorizontalLayout {
    alignment: parent.rightalign ? end : start;
    spacing: 2px;
    if rightalign : Text {
      text: root.text;
      y: 1px;
      horizontal-alignment: rightalign ? right : left;
      font-size: font-size;
      font-family: font-family;
      color: front-color;
    }
    Rectangle {
      width: root.font-size + 2px;
      height: root.font-size + 2px;
      border-color: front-color;
      border-width: 2px;
      background: checked ? checked-color : transparent;
      TouchArea {
        mouse-cursor: pointer;
        clicked => {
          root.checked = !root.checked;
          root.toggled(root.checked);
        }
      }
    }
    if !rightalign: Text {
      text: root.text;
      y: 1px;
      horizontal-alignment: rightalign ? right : left;
      font-size: font-size;
      font-family: font-family;
      color: front-color;
    }
  }
}

// Prototype for channel control
component ProtoChannelCtrl inherits Rectangle {
  in property <string> title : "Channel";
  in property <[string]> devs : ["no device"];
  in property <float> max-gain : 40.0;
  in property <float> min-gain : -60.0;
  in property <float> max-level-meter : 10.0;
  in property <float> min-level-meter : -110.0;
  in property <bool> hide_gain : false;
  in property <bool> hide_mute : false;
  in-out property <TChannel> channel : {
    gain: 0,
    mute: false,
    dev_id: 0,
    meter: {
      levels: [-10.0, -30.0],
      peak_flag: [false, false],
    },
  };

  callback mute_change(bool);
  callback gain_change(int);
  callback dev_change(float);

  preferred-width: 300px;
  preferred-height: 100px;

  Text {
    text: title;
    font-size: 11px;
    font-family: "Sans Serif";
    color: #dc8;
    width: 120px;
    x: 8px;
    y: 5px;
  }

  Path {
    x: 10px;
    y: 21px;
    width: parent.width - 80px;
    height: 1px;
    stroke: #444;
    stroke-width: 1px;
    MoveTo { x: 0; y: 0; }
    LineTo { x: (parent.width / 1px); y: 0; }
  }

  Text {
    text: "(Gain: " + channel.gain + " dB)";
    font-size: 11px;
    font-family: "Sans Serif";
    color: #888;
    horizontal-alignment: right;
    vertical-alignment: center;
    width: 90px;
    x: parent.width - (hide_mute ? 120px : 150px);
    y: 5px;
  }

  if !hide_mute: MiniCheckbox {
    text: "Mute";
    checked: channel.mute;
    height: 20px;
    x: parent.width - self.width - 7px;
    y: 5px;
    rightalign: true;
    toggled() => {
      channel.mute = self.checked;
      root.mute_change(self.checked);
    }
  }

  if !hide_gain: Slider {
    x: 160px;
    y: 32px;
    width: parent.width - 165px;
    minimum: 0;
    maximum: (max-gain - min-gain);
    value: channel.gain - min-gain;
    changed(value) => {
      let gain_value: int = value + min-gain;
      root.channel.gain = gain_value;
      root.gain_change(gain_value);
    }
  }

  LevelMeter {
    height: parent.height - 70px > 35px ? parent.height - 70px : 35px;
    width: parent.width - 16px;
    y: 60px;
    x: 8px;
    levels: channel.meter.levels;
    max-level: max-level-meter;
    min-level: min-level-meter;
    degree-step: (max-level-meter - min-level-meter) / 10; 
    orientation: horizontal;
  }
}

// Local channel controller component
component LocalChannelCtrl inherits Rectangle {
  in property <string> title : "Channel";
  in property <[string]> devs : ["no device"];
  in property <bool> inprogress : false;
  in property <float> max-gain : 40.0;
  in property <float> min-gain : -100.0;
  in property <float> max-level-meter : 10.0;
  in property <float> min-level-meter : -110.0;
  in property <bool> hide_mute : false;
  in-out property <bool> select_mode : false;
  in-out property <TChannel> channel : {
    gain: 0,
    mute: false,
    dev_id: 0,
    meter: {
      levels: [-10.0, -30.0],
      peak_flag: [false, false],
    },
  };

  callback mute_change(bool);
  callback gain_change(int);
  callback dev_change(float);

  ProtoChannelCtrl {
    title: root.title;
    devs: root.devs;
    max-gain: root.max-gain;
    min-gain: root.min-gain;
    max-level-meter: root.max-level-meter;
    min-level-meter: root.min-level-meter;
    channel: root.channel;
    hide_gain: select_mode;
    hide_mute: root.hide_mute;
    mute_change(v) => {
      root.mute_change(v);
    }
    gain_change(v) => {
      root.gain_change(v);
    }
    dev_change(v) => {
      root.dev_change(v);
    }
    if inprogress : Spinner {
      x: 40px;
      y: 27px;
      width: 30px;
      height: 30px;
      indeterminate: true;
    }
    if !inprogress : Rectangle {
      x: 10px;
      y: 27px;
      width: select_mode ? parent.width - 20px : 150px;
      height: 30px;
      if !select_mode: Text {
        x: 0px;
        text: "Device:";
        font-size: 12px;
        font-family: "Sans Serif";
        color: #aaa;
        horizontal-alignment: right;
        vertical-alignment: center;
        width: 55px;
        height: parent.height;
      }
      if select_mode: ComboBox {
        x:0px;
        width: parent.width;
        model: devs;
        current-index: root.channel.dev_id;
        selected() => {
          root.channel.dev_id = self.current-index;
          root.select_mode = false;
          root.dev_change(self.current-index);
        }
      }
      if !select_mode: ColorButton {
        x: 60px;
        width: parent.width -60px;
        height: 26px;
        text: devs[channel.dev_id];
        text-color: #fff;
        background-color: #444;
        hover-background-color: #666;
        clicked => {
          root.select_mode = true;
        }
      }
    }
  }
}

// Remote channel controller component
component RemoteChannelCtrl inherits Rectangle {
  in property <string> title : "Channel";
  in property <TRemoteMasterState> state : TRemoteMasterState.idle;
  in property <float> max-gain : 40.0;
  in property <float> min-gain : -100.0;
  in property <float> max-level-meter : 10.0;
  in property <float> min-level-meter : -110.0;
  in property <bool> hide_mute : false;
  in property <TMemberInfo> member : {
    site: -1,
    name: "Remote User",
    avatar: @image-url("./resources/icon-default-user.png"),
    description: "Remote User Description",
  };
  in-out property <TChannel> channel : {
    gain: 0,
    mute: false,
    dev_id: -1,
    meter: {
      levels: [-10.0, -30.0],
      peak_flag: [false, false],
    },
  };

  callback mute_change(bool);
  callback gain_change(int);
  ProtoChannelCtrl {
    title: root.title;
    max-gain: root.max-gain;
    min-gain: root.min-gain;
    max-level-meter: root.max-level-meter;
    min-level-meter: root.min-level-meter;
    channel: root.channel;
    hide_mute: root.hide_mute;
    mute_change(v) => {
        root.mute_change(v);
    }
    gain_change(v) => {
        root.gain_change(v);
    }
    if state == TRemoteMasterState.idle : Rectangle {
      x: 10px;
      y: 27px;
      width: 140px;
      height: 30px;

      Text {
        text: "No Connection";
        font-size: 14px;
        font-family: "Sans Serif";
        color: #966;
        vertical-alignment: center;
        horizontal-alignment: center;
        width: parent.width;
        height: parent.height;
      }
    }
    if state == TRemoteMasterState.connecting : Spinner {
      x: 10px;
      y: 27px;
      width: 30px;
      height: 30px;
      indeterminate: true;
    }
    if state == TRemoteMasterState.moinitoring : Rectangle {
      x: 20px;
      y: 27px;
      width: 140px;
      height: 30px;

      AvatarButton {
        x: 0px;
        y: 0px;
        avatar_image: member.avatar;
        width: 28px;
        height: 28px;
        border-radius: 15px;
        border-color: #888;
      }

      Text {
        x: 32px;
        text: member.name;
        font-size: 14px;
        font-family: "Sans Serif";
        color: #aaa;
        vertical-alignment: center;
        width: parent.width - 38px;
        height: parent.height;
      }
    }
  }
}

component MemberCtrl inherits Rectangle {
  in property <TMember> member : {
    info:{
      site: 1,
      name: "Remote User A",
      avatar: @image-url("./resources/icon-default-user.png"),
      description: "Remote User A Description",
    },
    channel: {
      gain: 0,
      mute: false,
      dev_id: 0,
      meter: {
        levels: [-5.0],
      },
    },
  };

  border-radius: 10px;
  border-width: 2px;
  border-color: #444;
  preferred-height: 290px;
  height: 56px;

  LevelMeter {
    x: 15px;
    y: 10px;
    width: 6px;
    height: 36px;
    levels: member.channel.meter.levels;
    max-level: 10.0;
    min-level: -110.0;
    orientation: vertical;
    show-ruler: false;
    show-peak: false;
  }

  AvatarButton {
    x: 30px;
    y: 10px;
    avatar_image: member.info.avatar;
    width: 36px;
    height: 36px;
    border-radius: 30px;
    border-color: #888;
  }

  Text {
    x: 76px;
    y: member.info.description != "" ? 12px : 18px;
    text: member.info.name;
    font-size: 14px;
    font-family: "Sans Serif";
    color: #aaa;
    width: parent.width - 86px;
  }
  if member.info.description != "": Text {
      x: 76px;
      y: 30px;
      text: member.info.description;
      font-size: 11px;
      font-family: "Sans Serif";
      color: #666;
      width: parent.width - 86px;
    }

}

// Main surface component for App window
export component AppSuf inherits Rectangle {
  in-out property <TSelfPlane> self_plane : {
    info: {
      site: -1,
      name: "New Moniters Meeting",
      avatar: @image-url("./resources/icon-default-user.png"),
      description: "Meeting description",
    },
    mode: TSelfMode.voicer,
    master_info: {
      site: -1,
      name: "New Moniters Meeting",
      avatar: @image-url("./resources/icon-default-user.png"),
      description: "Meeting description",
    },
    channel_master: {
      gain: 0,
      mute: false,
      dev_id: 0,
      meter: {
        levels: [0.0, -10.0],
        peak_flag: [true, false],
      },
    },
    channel_voice: {
      gain: 0,
      mute: false,
      dev_id: 1,
      meter: {
        levels: [-50.0],
        peak_flag: [false],
      },
    },
    channel_devout: {
      gain: 0,
      mute: false,
      dev_id: 2,
      meter: {
        levels: [-20.0, -30.0],
        peak_flag: [false, false],
      },
    },
    connect_state: TSelfConnectState.disconnected,
  };
  in-out property <[TMember]> members : [{
      info:{
        site: 1,
        name: "Remote User A",
        avatar: @image-url("./resources/icon-default-user.png"),
        description: "Remote User A Description",
      },
      channel: {
        gain: 0,
        mute: false,
        dev_id: 0,
        meter: {
          levels: [-5.0],
          peak_flag: [true],
        },
      },
    },
    {
      info:{
        site: 2,
        name: "Remote User B",
        avatar: @image-url("./resources/icon-default-user.png"),
        description: "Remote User B Description",
      },
      channel: {
        gain: 60,
        mute: false,
        dev_id: 0,
        meter: {
          levels: [-30.0],
          peak_flag: [false],
        },
      },
    },
    {
      info:{
        site: 3,
        name: "Remote User C",
        avatar: @image-url("./resources/icon-default-user.png"),
        description: "",
      },
      channel: {
        gain: -10,
        mute: true,
        dev_id: 0,
        meter: {
          levels: [-80.0],
          peak_flag: [false],
        },
      },
    },
    {
      info:{
        site: 4,
        name: "Remote User D",
        avatar: @image-url("./resources/icon-default-user.png"),
        description: "Remote User D Description",
      },
      channel: {
        gain: 20,
        mute: false,
        dev_id: 0,
        meter: {
          levels: [-15.0],
          peak_flag: [true],
        },
      },
    }
  ];
  in property <[string]> inputdevs : ["no device", "Microphone 1", "Microphone 2"];
  in property <[string]> outputdevs : ["no device", "Speaker 1", "Speaker 2"];
  
  private property <bool> mview_split : self.width > 500px; // members view split mode
  
  // Body aria
  Rectangle {
    width: parent.width > 700px ? 700px : parent.width;
    VerticalLayout {
      min-width: 320px;
      max-width: 700px;
      // Self Plane
      VerticalLayout {
        height: 352px;
        spacing: 4px;
        // Header aria (login, connect status and so on)
        Rectangle {
          height: 40px;
          AvatarButton {
            x: 15px;
            y: 6px;
            avatar_image: self_plane.info.avatar;
            width: 34px;
            height: 34px;
            border-radius: 16px;
            border-color: #888;
            clicked => {
              // Handle avatar click
            }
          }
          Rectangle {
            x: 52px;
            y: 10px;
            clip: true;
            width: parent.width - 182px;
            Text {
              font-size: 14px;
              font-family: "Sans Serif";
              text: self_plane.info.name;
              color: #aaa;
              states [
                  nodesc when self_plane.info.description == "" :{
                    y: 5px;
                  }
                  desc when self_plane.info.description != "" :{
                    y: 0px;
                  }
              ]
              x: 0px;
            }
            if self_plane.info.description != "": Text {
                font-size: 11px;
                font-family: "Sans Serif";
                text: self_plane.info.description;
                color: #666;
                x: 0px;
                y: 17px;
              }
          }
          // show connect button when disconnected
          if (self_plane.connect_state == TSelfConnectState.disconnected): ColorButton {
              text: "Connect";
              width: 90px;
              height: 26px;
              x: parent.width - 100px;
              y: 10px;
              text-color: #fff;
              background-color: #50A070;
              hover-background-color: #408060;
              clicked => {}
            }
          // show connecting status when connecting
          if (self_plane.connect_state == TSelfConnectState.connecting): Rectangle {
              x: parent.width - 130px;
              y: 10px;
              width: 130px;
              height: 30px;
              Text {
                text: "Connecting...";
                font-size: 12px;
                font-family: "Sans Serif";
                horizontal-alignment: right;
                width: 80px;
                x: 0px;
              }
              Spinner {
                x: 90px;
                y: 0px;
                width: 30px;
                height: 30px;
                indeterminate: false;
              }
            }
          // show disconnect button when connected
          if (self_plane.connect_state == TSelfConnectState.connected): ColorButton {
              text: "Disconnect";
              width: 90px;
              height: 26px;
              x: parent.width - 100px;
              y: 10px;
              text-color: #fff;
              background-color: #A05050;
              hover-background-color: #806060;
              clicked => {}
          }
        }
        // Control aria (mode switch, devices select and so on)
        if self_plane.mode == TSelfMode.master : LocalChannelCtrl {
          title: "Master Channel";
          devs: inputdevs;
          channel: self_plane.channel_master;
          mute_change(v) => {}
          gain_change(v) => {}
          dev_change(v) => {}
        }
        if self_plane.mode == TSelfMode.voicer : RemoteChannelCtrl {
          title: "Master - Remote";
          state: TRemoteMasterState.idle;
          member: self_plane.master_info;
          channel: self_plane.channel_master;
          mute_change(v) => {}
          gain_change(v) => {}
        }
        LocalChannelCtrl {
          title: "Voice Sender";
          devs: inputdevs;
          channel: self_plane.channel_voice;
          mute_change(v) => {}
          gain_change(v) => {}
          dev_change(v) => {}
        }
        LocalChannelCtrl {
          title: "Output";
          devs: outputdevs;
          channel: self_plane.channel_devout;
          mute_change(v) => {}
          gain_change(v) => {}
          dev_change(v) => {}
        }
      }
      Path {
        height: 12px;
        stroke: #666;
        stroke-width: 2px;
        MoveTo {
          x: 0;
          y: 6;
        }
        LineTo {
          x: (parent.width / 1px);
          y: 6;
        }
      }
      // Members List
      ScrollView {
        vertical-scrollbar-policy: as-needed;
        horizontal-scrollbar-policy: always-off;
        viewport-height: (mview_split ? Math.ceil(members.length/2) * 61px : members.length * 61px) + 5px;
        for idx in members.length : MemberCtrl {
          states [
            split when mview_split : {
              x: (Math.mod(idx, 2) * (parent.width / 2)) + 5px;
              y: Math.floor(idx / 2) * (self.height + 5px) + 5px;
              width: (parent.width / 2 - 10px);
            }
            single when !mview_split : {
              x: 5px;
              y: idx * (self.height + 5px) + 5px;
              width: (parent.width - 10px);
            }
          ]
          member: members[idx];
        }
      }
    }
  }
  // Footer aria (status, hints and so on)
  Rectangle {
  }
}

export component MainWindow inherits Window {
    in property <[TMember]> members;
    callback update_ctrl(string, int);
    callback close();
    preferred-width: 350px;
    preferred-height: 500px;
    min-width: 320px;
    min-height:500px;
    max-width: 700px;
    MenuBar {
        Menu {
            title: "Operations";
            MenuItem {
                title: "Config";
            }
            MenuSeparator {}
            MenuItem {
                title: "Exit";
                activated => {
                    root.close();
                }
            }
        }
        Menu {
            title: "Help";
            MenuItem {
                title: "About";
            }
        }
    }
    AppSuf {
    }
}
